<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¯¾æˆ¦ã®è¨˜éŒ²ï¼ˆå…¬é–‹ï¼‰ | ã—ãŠã‚“ã®ç ”ç©¶ãƒ¡ãƒ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho:wght@600&family=Shippori+Mincho:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --card:#ffffffcc;
    --stroke:rgba(255,184,112,.55);
    --text:#2f2830;
    --muted:#6c6370;
    --accent:#ff7a2f;
    --accent2:#ffb870;
    --danger:#d83a3a;
    --ok:#1d8f5a;
    --shadow: 0 14px 38px rgba(0,0,0,.08);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", "Hiragino Sans", "Noto Sans JP", sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 600px at 15% 5%, rgba(255,200,220,.28), transparent 60%),
      radial-gradient(900px 700px at 85% 15%, rgba(255,184,112,.25), transparent 60%),
      linear-gradient(180deg, #fffaf5, #fff3ea);
    min-height:100vh;
  }

  header{
    padding:18px 24px 10px;
    max-width:1100px;
    margin:0 auto;
    display:flex;
    gap:12px;
    align-items:flex-end;
    justify-content:space-between;
  }
  .topbar{
    position: sticky;
    top: 0;
    z-index: 50;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 16px;
    background: rgba(255,255,255,.65);
    border-bottom: 1px solid rgba(0,0,0,.06);
    backdrop-filter: blur(8px);
  }
  .topbarLeft{
    font-size:13px;
    color: var(--muted);
    display:flex;
    gap:8px;
    align-items:center;
  }
  .topbarRight{
    font-size:13px;
    color: var(--muted);
    text-decoration:none;
  }
  .topbarRight:hover{
    text-decoration:underline;
  }
  .title{
    font-weight:600;
    font-size:20px;
    letter-spacing:.02em;
  }
  .sub{
    margin-top:4px;
    color:var(--muted);
    font-size:12px;
  }
  .headerRight{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .chip{
    font-size:12px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    color:var(--muted);
  }
  .backBtn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    background:#fff;
    border:1px solid rgba(0,0,0,.12);
    color:var(--text);
    text-decoration:none;
    font-weight:800;
  }
  .backBtn:hover{ border-color: rgba(255,122,47,.45); }

  .wrap{
    max-width:1100px;
    margin:0 auto;
    padding:0 16px 22px;
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:14px;
  }
  @media (max-width: 980px){
    .wrap{grid-template-columns:1fr}
  }

  .card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    backdrop-filter: blur(8px);
  }
  .card h2{
    font-size:14px;
    margin:0;
    padding:14px 14px 10px;
    border-bottom:1px solid rgba(0,0,0,.06);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  /* tools */
  .tools{
    padding:12px 14px 14px;
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  input, select{
    padding:10px 10px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
    color:var(--text);
    outline:none;
  }
  .tools input{max-width:320px; flex:1 1 240px}
  button{
    border:0;
    border-radius:12px;
    padding:10px 12px;
    font-weight:800;
    cursor:pointer;
  }
  .ghost{
    background:#fff;
    border:1px solid rgba(0,0,0,.12);
    color:var(--text);
  }

  /* list */
  .list{padding:10px 14px 14px}
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0 8px;
  }
  td{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    padding:10px;
    font-size:13px;
    vertical-align:top;
  }
  td:first-child{border-radius:12px 0 0 12px}
  td:last-child{border-radius:0 12px 12px 0}
  .mini{color:var(--muted); font-size:12px}
  .empty{color:var(--muted); padding:10px 0; font-size:13px}

  .rowlink{ cursor:pointer; }
  .rowlink:hover td{
    border-color: rgba(255,122,47,.35);
    box-shadow: 0 10px 24px rgba(0,0,0,.06);
  }
  .active td{ border-color: rgba(255,122,47,.55); }

  /* detail */
  .detail{padding:14px}
  .detailTitle{
    font-family:"Zen Old Mincho", serif;
    font-size:18px;
    margin:0;
  }
  .meta{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px;
    color:var(--muted);
    font-size:12px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
  }
  .win{color:var(--ok); border-color: rgba(29,143,90,.25)}
  .lose{color:var(--danger); border-color: rgba(216,58,58,.25)}
  .box{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
    padding:10px;
    margin-top:10px;
  }
  .cap{font-size:12px; color:var(--muted); margin-bottom:6px}
  .body{white-space:pre-wrap; line-height:1.55; font-size:14px}
  .twoCol{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:10px;
  }
  @media (max-width: 980px){
    .twoCol{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbarLeft">ğŸ§ª å¯¾æˆ¦ã®è¨˜éŒ²</div>
  <a class="topbarRight" href="memos.html">â† ç ”ç©¶ãƒ¡ãƒ¢ã¸æˆ»ã‚‹</a>
</div>

<header>
  <div>
    <div class="title">å¯¾æˆ¦ã®è¨˜éŒ²</div>
    <div class="sub">ä¸€è¦§ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å³å´ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
  </div>
  <div class="headerRight">
    <div class="chip" id="countChip">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </div>
</header>

<div class="wrap">

  <section class="card">
    <h2>
      <span>ä¸€è¦§</span>
      <span class="chip" id="todayChip">â€”</span>
    </h2>

    <div class="tools">
      <input id="q" placeholder="æ¤œç´¢ï¼ˆãƒ¡ã‚¬ãƒŸ/ç›¸æ‰‹/ã‚¿ã‚°/åçœç‚¹/æ”¹å–„ç‚¹/BANï¼‰" />
      <select id="filter">
        <option value="ALL">å…¨ã¦</option>
        <option value="WIN">å‹ã¡ã®ã¿</option>
        <option value="LOSE">è² ã‘ã®ã¿</option>
        <option value="TODAY">ä»Šæ—¥ã®ã¿</option>
      </select>
      <button class="ghost" id="reload" type="button">å†èª­ã¿è¾¼ã¿</button>
    </div>

    <div class="list" id="listArea"></div>
  </section>

  <section class="card detail">
    <h2>
      <span>è©³ç´°</span>
      <span class="chip" id="detailChip">â€”</span>
    </h2>

    <h3 class="detailTitle" id="detailTitle">â€”</h3>
    <div class="meta" id="detailMeta">ä¸€è¦§ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„</div>

      <div class="twoCol">
        <div class="box">
        <div class="cap">ä»Šæ—¥ã®å‹ç‡</div>
        <div class="body"><span id="winrateTodayBig" style="font-weight:900;font-size:22px;">â€”</span></div>
        <div class="mini" id="todayWL">â€”</div>
      </div>

      <div class="box">
        <div class="cap">å…¨ä½“å‹ç‡</div>
        <div class="body"><span id="winrateAllBig" style="font-weight:900;font-size:22px;">â€”</span></div>
        <div class="mini" id="allWL">â€”</div>
      </div>
    </div>

    <div class="box">
      <div class="cap">ç›´è¿‘14æ—¥ å‹ç‡æ¨ç§»</div>
      <canvas id="winChart" width="640" height="220" style="width:100%;height:220px;"></canvas>
      <div class="mini" id="chartNote">â€”</div>
    </div> 

    <div class="twoCol">
      <div class="box">
        <div class="cap">è‡ªåˆ†ãƒ¡ã‚¬ãƒŸï¼ˆä½¿ç”¨ï¼‰</div>
        <div class="body" id="detailMyTeam">â€”</div>
      </div>
      <div class="box">
        <div class="cap">ç›¸æ‰‹ãƒ¡ã‚¬ãƒŸï¼ˆä½¿ç”¨ï¼‰</div>
        <div class="body" id="detailTheirTeam">â€”</div>
      </div>
    </div>

    <div class="twoCol">
      <div class="box">
        <div class="cap">BANï¼ˆè‡ªåˆ†å´ï¼‰</div>
        <div class="body" id="detailMyBan">â€”</div>
      </div>
      <div class="box">
        <div class="cap">BANï¼ˆç›¸æ‰‹å´ï¼‰</div>
        <div class="body" id="detailTheirBan">â€”</div>
      </div>
    </div>

    <div class="box">
      <div class="cap">åçœç‚¹</div>
      <div class="body" id="detailPivot">â€”</div>
    </div>
    <div class="box">
      <div class="cap">æ”¹å–„ç‚¹</div>
      <div class="body" id="detailNext">â€”</div>
    </div>
  </section>

</div>

<script>
  const DATA_URL = "./data/matches.json";
  const $ = (id)=>document.getElementById(id);

  let ALL_ROWS = [];
  let ACTIVE_ID = null;

  const todayKey = ()=>{
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function pairName(a,b){
    const x = (a||"").trim();
    const y = (b||"").trim();
    if(x && y) return `${x}/${y}`;
    return x || y || "?";
  }

  function calcToday(rows){
    const t = todayKey();
    const today = rows.filter(r => (r.ts||"").startsWith(t));
    const w = today.filter(r => r.result==="WIN").length;
    const l = today.filter(r => r.result==="LOSE").length;
    return {today, w, l};
  }

  function calcWinRate(rows){
    const w = rows.filter(r=>r.result==="WIN").length;
    const l = rows.filter(r=>r.result==="LOSE").length;
    const rate = (w+l)>0 ? Math.round((w/(w+l))*100) : null;
    return {w,l,rate};
  }

  function pickNewest(rows){
    if(rows.length===0) return null;
    return rows.reduce((best, r)=> (best?.id ?? 0) < (r?.id ?? 0) ? r : best, rows[0]);
  }

  function formatRes(r){
    const isWin = r.result==="WIN";
    return {
      resClass: isWin ? "badge win" : "badge lose",
      resText: isWin ? "å‹ã¡" : "è² ã‘",
      mark: isWin ? "â—" : "Ã—"
    };
  }

  function renderDetail(r){
    if(!r){
      $("detailTitle").textContent = "â€”";
      $("detailMeta").textContent = "ä¸€è¦§ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„";
      $("detailMyTeam").textContent = "â€”";
      $("detailTheirTeam").textContent = "â€”";
      $("detailMyBan").textContent = "â€”";
      $("detailTheirBan").textContent = "â€”";
      $("detailPivot").textContent = "â€”";
      $("detailNext").textContent = "â€”";
      $("detailChip").textContent = "â€”";
      return;
    }

    const {resClass, resText} = formatRes(r);

    const myTeam = pairName(r.my1, r.my2);
    const theirTeam = pairName(r.their1, r.their2);

    $("detailTitle").textContent = `${myTeam} vs ${theirTeam}`;
    $("detailChip").textContent = r.ts || "â€”";

    const tags = [];
    tags.push(`<span class="${resClass}">â— ${resText}</span>`);
    if(r.turn) tags.push(`<span class="badge">${escapeHtml(r.turn)}</span>`);
    if(r.opponent) tags.push(`<span class="badge">ç›¸æ‰‹ï¼š${escapeHtml(r.opponent)}</span>`);
    if(r.tag) tags.push(`<span class="badge">#${escapeHtml(r.tag)}</span>`);
    if(r.ts) tags.push(`<span class="badge">${escapeHtml(r.ts)}</span>`);
    $("detailMeta").innerHTML = tags.join(" ");

    $("detailMyTeam").textContent = myTeam;
    $("detailTheirTeam").textContent = theirTeam;
    $("detailMyBan").textContent = r.myBan || "â€”";
    $("detailTheirBan").textContent = r.theirBan || "â€”";
    $("detailPivot").textContent = r.pivot || "â€”";
    $("detailNext").textContent = r.next || "â€”";
  }

  function getFilteredRows(){
    const q = $("q").value.trim().toLowerCase();
    const f = $("filter").value;

    const tKey = todayKey();
    let rows = ALL_ROWS.slice();

    if(f==="WIN") rows = rows.filter(r=>r.result==="WIN");
    if(f==="LOSE") rows = rows.filter(r=>r.result==="LOSE");
    if(f==="TODAY") rows = rows.filter(r=>(r.ts||"").startsWith(tKey));

    if(q){
      rows = rows.filter(r=>{
        const hay = [
          r.opponent, r.my1, r.my2, r.their1, r.their2, r.turn, r.tag, r.pivot, r.next, r.ts, r.result,
          r.myBan, r.theirBan
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    rows.sort((a,b)=> (b.id ?? 0) - (a.id ?? 0));
    return rows;
  }

  function renderList(){
    const rows = getFilteredRows();

    if(rows.length===0){
      $("listArea").innerHTML = `<div class="empty">è©²å½“ãªã—</div>`;
      return;
    }

    let html = `<table><tbody>`;
    for(const r of rows){
      const {mark, resText} = formatRes(r);

      const myTeam = pairName(r.my1, r.my2);
      const theirTeam = pairName(r.their1, r.their2);

      const shortPivot = (r.pivot || "").trim();
      const pivotOne = shortPivot.length > 34 ? shortPivot.slice(0,34) + "â€¦" : shortPivot;

      const isActive = (ACTIVE_ID !== null && String(r.id) === String(ACTIVE_ID));
      html += `
        <tr class="rowlink ${isActive ? "active" : ""}" data-id="${escapeHtml(String(r.id ?? ""))}">
          <td style="width:94px">
            <span class="mini">${escapeHtml((r.ts||"").slice(11))}</span><br>
            <b>${mark} ${resText}</b>
          </td>
          <td>
            <b>${escapeHtml(myTeam)} vs ${escapeHtml(theirTeam)}</b>
            ${r.tag ? `<span class="mini">ã€€#${escapeHtml(r.tag)}</span>` : ""}
            ${pivotOne ? `<div class="mini">åçœï¼š${escapeHtml(pivotOne)}</div>` : `<div class="mini">åçœï¼šâ€”</div>`}
          </td>
        </tr>
      `;
    }
    html += `</tbody></table>`;
    $("listArea").innerHTML = html;

    document.querySelectorAll("[data-id]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const id = el.getAttribute("data-id");
        ACTIVE_ID = id;
        const r = ALL_ROWS.find(x => String(x.id) === String(id));
        renderDetail(r);
        renderList();
      });
    });
  }

  // --- chart (è»½é‡) ---
  function groupByDay(rows){
    const map = {};
    for(const r of rows){
      const day = (r.ts||"").slice(0,10);
      if(!day) continue;
      if(!map[day]) map[day] = {w:0,l:0};
      if(r.result==="WIN") map[day].w++;
      if(r.result==="LOSE") map[day].l++;
    }
    return map;
  }
  function lastNDaysKeys(n){
    const keys = [];
    const d = new Date();
    for(let i=n-1;i>=0;i--){
      const x = new Date(d);
      x.setDate(d.getDate()-i);
      const pad=(k)=>String(k).padStart(2,"0");
      keys.push(`${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}`);
    }
    return keys;
  }
  function drawWinChart(rows){
    const cvs = $("winChart");
    const note = $("chartNote");
    if(!cvs || !cvs.getContext) return;

    const ctx = cvs.getContext("2d");
    const W = cvs.width, H = cvs.height;
    ctx.clearRect(0,0,W,H);

    const days = lastNDaysKeys(14);
    const byDay = groupByDay(rows);

    const points = days.map(d=>{
      const v = byDay[d] || {w:0,l:0};
      const total = v.w+v.l;
      const rate = total>0 ? (v.w/total)*100 : null;
      return {d, w:v.w, l:v.l, rate};
    });

    const padL = 34, padR = 10, padT = 10, padB = 26;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    ctx.globalAlpha = 0.12;
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 1;
    for(let i=0;i<=4;i++){
      const y = padT + (plotH*i/4);
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(padL+plotW, y);
      ctx.stroke();
    }
    ctx.globalAlpha = 1;

    ctx.fillStyle = "#000";
    ctx.globalAlpha = 0.55;
    ctx.font = "12px system-ui, sans-serif";
    [100,50,0].forEach(v=>{
      const y = padT + plotH*(1 - v/100);
      ctx.fillText(String(v), 6, y+4);
    });
    ctx.globalAlpha = 1;

    const xs = points.map((p,i)=> padL + (plotW*(i/(points.length-1))));
    const yOf = (rate)=> padT + plotH*(1 - (rate/100));

    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.beginPath();
    let started = false;
    points.forEach((p,i)=>{
      if(p.rate===null) return;
      const x = xs[i];
      const y = yOf(p.rate);
      if(!started){ ctx.moveTo(x,y); started=true; }
      else ctx.lineTo(x,y);
    });
    if(started) ctx.stroke();

    ctx.fillStyle = "#000";
    points.forEach((p,i)=>{
      if(p.rate===null) return;
      const x = xs[i];
      const y = yOf(p.rate);
      ctx.beginPath();
      ctx.arc(x,y,3,0,Math.PI*2);
      ctx.fill();
    });

    ctx.globalAlpha = 0.55;
    ctx.font = "12px system-ui, sans-serif";
    const idx7 = points.length-8;
    if(idx7>=0) ctx.fillText(points[idx7].d.slice(5), xs[idx7]-14, H-8);
    ctx.fillText(points[points.length-1].d.slice(5), xs[points.length-1]-14, H-8);
    ctx.globalAlpha = 1;

    const playedDays = points.filter(p=>p.rate!==null).length;
    if(note) note.textContent = `ç›´è¿‘14æ—¥ï¼šå¯¾æˆ¦ãŒã‚ã£ãŸæ—¥ ${playedDays}æ—¥ / ${points.length}æ—¥`;
  }

  async function fetchRows(){
    // window.location ã‚’åŸºæº–ã«ã—ã¦ã‚ºãƒ¬ã‚’é˜²ã
    const url = new URL(DATA_URL, window.location.href);
    url.searchParams.set("v", Date.now());

    const res = await fetch(url.toString(), { cache: "no-store" });
    const text = await res.text();

    if(!res.ok){
      throw new Error(`fetch failed: ${res.status} ${res.statusText}`);
    }
    if(text.trim().startsWith("<")){
      // 404ãªã©HTMLã‚’æ´ã‚“ã ã¨ã
      throw new Error("Got HTML instead of JSON (path mismatch / cache / open location).");
    }

    const rows = JSON.parse(text);
    return Array.isArray(rows) ? rows : [];
  }

  async function refresh(){
    $("countChip").textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
    try{
      ALL_ROWS = await fetchRows();
      $("countChip").textContent = `${ALL_ROWS.length}ä»¶`;

      const tKey = todayKey();
      const todayRows = ALL_ROWS.filter(r => (r.ts||"").startsWith(tKey));

      const today = calcWinRate(todayRows);
      const all = calcWinRate(ALL_ROWS);

      $("winrateTodayBig").textContent = (today.rate===null) ? "â€”" : `${today.rate}%`;
      $("todayWL").textContent = `ä»Šæ—¥ï¼š${today.w}å‹${today.l}æ•—`;

      $("winrateAllBig").textContent = (all.rate===null) ? "â€”" : `${all.rate}%`;
      $("allWL").textContent = `å…¨ä½“ï¼š${all.w}å‹${all.l}æ•—`;

      drawWinChart(ALL_ROWS);

      const {w,l} = calcToday(ALL_ROWS);
      $("todayChip").textContent = `ä»Šæ—¥ï¼š${w}å‹${l}æ•—`;

      const newest = pickNewest(ALL_ROWS);
      ACTIVE_ID = newest?.id ?? null;
      renderDetail(newest);
      renderList();
    }catch(e){
      $("countChip").textContent = "èª­ã¿è¾¼ã¿å¤±æ•—";
      $("listArea").innerHTML = `<div class="empty">data/matches.json ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</div>`;
      renderDetail(null);
      $("detailMeta").textContent = String(e);
    }
  }

  $("q").addEventListener("input", ()=>{ renderList(); });
  $("filter").addEventListener("change", ()=>{ renderList(); });
  $("reload").addEventListener("click", refresh);

  refresh();
</script>

</body>
</html>