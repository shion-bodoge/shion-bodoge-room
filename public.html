<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¯¾æˆ¦ã®è¨˜éŒ²ï¼ˆå…¬é–‹ï¼‰</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho:wght@600&family=Shippori+Mincho:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1: rgba(14,165,233,.13);
    --bg2: rgba(34,197,94,.10);
    --bgTop: #f7fbff;
    --bgBottom: #f7fff9;

    --text:#1f2937;
    --muted:#6b7280;

    --card: rgba(255,255,255,.86);
    --stroke: rgba(31,41,55,.14);

    --accent:#ff7a2f;
    --accent2:#ffd2a8;

    --shadow: 0 14px 38px rgba(0,0,0,.08);
    --r:18px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI","Hiragino Sans","Noto Sans JP",sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 600px at 18% 6%, var(--bg1), transparent 60%),
      radial-gradient(900px 700px at 85% 15%, var(--bg2), transparent 60%),
      linear-gradient(180deg, var(--bgTop), var(--bgBottom));
    min-height:100vh;
  }

  header{
    padding:18px 16px 10px;
    max-width:1100px;
    margin:0 auto;
    display:flex;
    gap:12px;
    align-items:flex-end;
    justify-content:space-between;
  }
  .title{font-weight:900;font-size:18px;letter-spacing:.02em}
  .rightHead{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{
    font-size:12px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    color:var(--muted);
    white-space:nowrap;
  }
  a{color:inherit}

  .wrap{
    max-width:1100px;
    margin:0 auto;
    padding:0 16px 26px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    backdrop-filter: blur(8px);
  }

  /* ===== Top summary ===== */
  .hero{padding:14px}
  .heroHead{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
    margin-bottom:10px;
  }
  .heroTitle{
    font-weight:600;
    font-size:28px;
    margin:0;
  }
  .heroGrid{
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:14px;
    align-items:stretch;
  }
  @media (max-width: 980px){ .heroGrid{grid-template-columns:1fr} }

  .panel{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:16px;
    padding:12px;
    height:100%;
  }
  .panelTitle{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .panelTitle h3{
    font-size:14px;
    margin:0;
    font-weight:900;
  }
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,input{font:inherit;outline:none}
  .controls select{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
    font-size:12px;
  }

  .rateBox{display:grid;gap:10px}
  .rateItem{display:grid;gap:6px}
  .cap{font-size:12px;color:var(--muted)}
  .rate{
    font-size:40px;
    font-weight:900;
    line-height:1;
    letter-spacing:.01em;
  }
  .mini{font-size:12px;color:var(--muted)}

  .chartWrap{height:240px;display:flex;flex-direction:column;gap:8px}
  .chartTitle{font-size:14px;font-weight:900;margin:0}
  canvas{
    width:100%;
    height:100%;
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:16px;
  }

  /* ===== List ===== */
  .listCard h2{
    font-size:16px;
    margin:0;
    padding:14px 14px 10px;
    border-bottom:1px solid rgba(0,0,0,.06);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .listBody{
    padding:12px 14px 14px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .toolbar{
    display:grid;
    grid-template-columns: 1fr 140px 200px;
    gap:10px;
    align-items:center;
  }
  @media (max-width: 820px){ .toolbar{grid-template-columns:1fr} }

  .search{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
  }
  .toolbar select{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
  }

  .paging{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .pagerBtns{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  button{
    border:0;
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
  }
  .ghost{background:#fff;border:1px solid rgba(0,0,0,.12);color:var(--text)}
  .btnSm{padding:7px 10px;border-radius:999px;font-size:12px}
  .btnSm[disabled]{opacity:.45;cursor:not-allowed}
  .btnSm.active{
    border-color: rgba(255,122,47,.55);
    box-shadow: 0 0 0 3px rgba(255,122,47,.18);
  }

  .countLine{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .rows{display:flex;flex-direction:column;gap:8px}

  .row{
    display:grid;
    grid-template-columns: 96px 1fr;
    gap:10px;
    padding:10px;
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
  }
  @media (max-width: 520px){ .row{grid-template-columns: 86px 1fr} }

  .rowLeft{
    display:flex;
    flex-direction:column;
    gap:6px;
    align-items:flex-start;
    justify-content:center;
    border-right:1px dashed rgba(0,0,0,.10);
    padding-right:8px;
  }
  .time{font-size:12px;color:var(--muted)}
  .badge{
    font-size:12px;
    font-weight:900;
    display:inline-flex;
    gap:6px;
    align-items:center;
  }
  .dot{
    width:10px;height:10px;border-radius:999px;display:inline-block;
    border:1px solid rgba(0,0,0,.15);
  }
  .dot.win{background: rgba(29,143,90,.18); border-color: rgba(29,143,90,.35)}
  .dot.lose{background: rgba(216,58,58,.14); border-color: rgba(216,58,58,.35)}

  .rowMain{display:flex;flex-direction:column;gap:6px;min-width:0}
  .matchLine{display:flex;gap:8px;flex-wrap:wrap;align-items:baseline}
  .matchTitle{
    font-weight:900;
    color:var(--accent);
    text-decoration:underline;
    cursor:pointer;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:100%;
  }
  .pill{
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background: rgba(0,0,0,.04);
    border:1px solid rgba(0,0,0,.08);
    color:var(--muted);
    white-space:nowrap;
  }
  .subLine{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .empty{color:var(--muted);font-size:13px;padding:10px 0}

  /* ===== Modal (detail) ===== */
  .modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.35);
    padding:16px;
    z-index:999;
    align-items:center;
    justify-content:center;
  }
  .modal .inner{
    max-width:720px;
    width:100%;
    max-height: calc(100vh - 32px);
    overflow:auto;
    padding:14px;
  }
  .modalTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .modalTitle{
    margin:0;
    font-size:16px;
    font-weight:900;
  }
  .helpBox{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
    padding:12px;
    line-height:1.7;
    font-size:14px;
  }
  .detailMeta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}

  @media (max-width: 520px){
    header{padding:14px 12px 8px;}
    .wrap{padding:0 12px 18px;}
    .heroTitle{font-size:24px}
    .rate{font-size:36px}
    .modal{padding:10px;}
  }
</style>
</head>

<body>
<header>
  <div class="title">å¯¾æˆ¦ã®è¨˜éŒ²</div>
  <div class="rightHead">
    <!-- å¿…è¦ã«å¿œã˜ã¦æˆ»ã‚Šå…ˆã‚’å¤‰æ›´ -->
    <a class="chip" href="memos.html" style="text-decoration:none;">â†ç ”ç©¶ãƒ¡ãƒ¢ã¸æˆ»ã‚‹</a>
    <span class="chip" id="countChip">0ä»¶</span>
  </div>
</header>

<div class="wrap">
  <!-- TOP -->
  <section class="card hero">
    <div class="heroHead">
      <h1 class="heroTitle">å¯¾æˆ¦ã®è¨˜éŒ²</h1>
      <span class="chip" id="metaChip">èª­è¾¼ä¸­â€¦</span>
    </div>

    <div class="heroGrid">
      <!-- Left rates -->
      <div class="panel">
        <div class="panelTitle">
          <h3>å‹ç‡</h3>
          <div class="controls">
            <select id="statsType" aria-label="åŒºåˆ†">
              <option value="ALL">åŒºåˆ†ï¼šãªã—ï¼ˆå…¨éƒ¨ï¼‰</option>
              <option value="tournament">åŒºåˆ†ï¼šå¤§ä¼š</option>
              <option value="free">åŒºåˆ†ï¼šãƒ•ãƒªãƒ—</option>
              <option value="rank">åŒºåˆ†ï¼šãƒ©ãƒ³ã‚¯</option>
            </select>
            <select id="statsYear" aria-label="å¹´"></select>
          </div>
        </div>

        <div class="rateBox">
          <div class="rateItem">
            <div class="cap">ä»Šæ—¥ã®å‹ç‡</div>
            <div class="rate" id="rateToday">â€”</div>
            <div class="mini" id="rateTodayMeta"></div>
          </div>

          <div class="rateItem">
            <div class="cap">é¸æŠã—ãŸå¹´ã®å‹ç‡</div>
            <div class="rate" id="rateYear">â€”</div>
            <div class="mini" id="rateYearMeta"></div>
          </div>
        </div>
      </div>

      <!-- Right chart -->
      <div class="panel">
        <div class="chartWrap">
          <div style="display:flex;justify-content:space-between;align-items:baseline;gap:10px;flex-wrap:wrap;">
            <p class="chartTitle">ç›´è¿‘7æ—¥é–“ã®å‹ç‡æ¨ç§»</p>
            <span class="mini">â€»åŒºåˆ†ãƒ•ã‚£ãƒ«ã‚¿ã«è¿½å¾“</span>
          </div>
          <canvas id="chart" width="900" height="300"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- LIST -->
  <section class="card listCard" id="listTop">
    <h2>
      <span>ä¸€è¦§ï¼ˆ30ä»¶ã”ã¨ï¼‰</span>
      <span class="chip" id="todayChip">ä»Šæ—¥ï¼š0å‹0æ•—</span>
    </h2>

    <div class="listBody">
      <div class="toolbar">
        <input id="q" class="search" placeholder="æ¤œç´¢ï¼ˆãƒ¡ã‚¬ãƒŸ/ã‚¿ã‚°/åçœç‚¹/BANï¼‰" />
        <select id="resultFilter" aria-label="å‹æ•—ãƒ•ã‚£ãƒ«ã‚¿">
          <option value="ALL">å…¨ã¦</option>
          <option value="WIN">å‹ã¡</option>
          <option value="LOSE">è² ã‘</option>
          <option value="TODAY">ä»Šæ—¥</option>
        </select>
        <select id="typeFilter" aria-label="åŒºåˆ†ãƒ•ã‚£ãƒ«ã‚¿">
          <option value="ALL">åŒºåˆ†ï¼šãªã—ï¼ˆå…¨éƒ¨ï¼‰</option>
          <option value="tournament">åŒºåˆ†ï¼šå¤§ä¼š</option>
          <option value="free">åŒºåˆ†ï¼šãƒ•ãƒªãƒ—</option>
          <option value="rank">åŒºåˆ†ï¼šãƒ©ãƒ³ã‚¯</option>
        </select>
      </div>

      <div class="paging">
        <div class="pagerBtns">
          <button class="ghost btnSm" id="prevBtn" type="button">â†</button>
          <div id="pageNums" class="pagerBtns"></div>
          <button class="ghost btnSm" id="nextBtn" type="button">â†’</button>
        </div>

        <div class="countLine">
          <span class="mini" id="rangeText">0-0 / 0ä»¶</span>
        </div>
      </div>

      <!-- â€»ãƒšãƒ¼ã‚¸å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼šã“ã“ã«å›ºå®šé«˜ã•ã¯æŒãŸã›ã¾ã›ã‚“ -->
      <div class="rows" id="rows"></div>
    </div>
  </section>
</div>

<!-- Detail modal -->
<div id="detailModal" class="modal" aria-hidden="true">
  <div class="card inner">
    <div class="modalTop">
      <h3 class="modalTitle">ï¼œè©¦åˆã®è©³ç´°ï¼</h3>
      <button class="ghost" type="button" id="closeDetail">é–‰ã˜ã‚‹</button>
    </div>

    <div class="helpBox">
      <div class="detailMeta" id="detailMeta"></div>

      <div style="display:grid;gap:10px;">
        <div>
          <div class="cap">åŸºæœ¬æƒ…å ±</div>
          <div id="detailBase" style="white-space:pre-wrap;word-break:break-word;">â€”</div>
        </div>
        <div>
          <div class="cap">BAN</div>
          <div id="detailBan" style="white-space:pre-wrap;word-break:break-word;">â€”</div>
        </div>
        <div>
          <div class="cap">åçœç‚¹</div>
          <div id="detailPivot" style="white-space:pre-wrap;word-break:break-word;">â€”</div>
        </div>
        <div>
          <div class="cap">æ”¹å–„ç‚¹</div>
          <div id="detailNext" style="white-space:pre-wrap;word-break:break-word;">â€”</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // å…¬é–‹ãƒšãƒ¼ã‚¸ã¯ã“ã“ã ã‘è¦‹ã«è¡Œãï¼ˆç›¸å¯¾ãƒ‘ã‚¹ï¼‰
  const DATA_URL = "./data/tsumilog.json";
  const PER_PAGE = 30;

  const $ = (id) => document.getElementById(id);
  const pad2 = (n)=> String(n).padStart(2,"0");
  const todayKey = ()=>{
    const d=new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };
  const thisYear = ()=> String(new Date().getFullYear());

  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function norm(s){
    return String(s||"").trim().normalize("NFKC").toLowerCase();
  }

  const TYPE_LABEL = { tournament:"å¤§ä¼š", free:"ãƒ•ãƒªãƒ—", rank:"ãƒ©ãƒ³ã‚¯" };
  function typeText(v){ return TYPE_LABEL[v] || "â€”"; }

  function turnText(v){
    if(v==="first") return "å…ˆæ‰‹";
    if(v==="second") return "å¾Œæ‰‹";
    if(v==="å…ˆæ‰‹" || v==="å¾Œæ‰‹") return v;
    return "â€”";
  }

  function parseCreatedAt(u){
    const s = String(u.created_at||"");
    const m = s.match(/^(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2})/);
    if(m) return { date:m[1], time:m[2] };
    const d = String(u.date||"");
    return { date:d, time:"" };
  }

  function pairName(a,b){
    const x=(a||"").trim(), y=(b||"").trim();
    if(x && y) return `${x}/${y}`;
    return x || y || "?";
  }

  function summarize(rows){
    const w = rows.filter(r=>r.result==="WIN").length;
    const l = rows.filter(r=>r.result==="LOSE").length;
    const total = w+l;
    const rate = total>0 ? Math.round((w/total)*100) : null;
    return {w,l,total,rate};
  }

  function filterByType(rows, type){
    if(!type || type==="ALL") return rows;
    return rows.filter(r => (r.match_type||"")===type);
  }

  function yearOptions(rows){
    const set = new Set();
    for(const r of rows){
      const d = String(r.date||"");
      const y = d.slice(0,4);
      if(/^\d{4}$/.test(y)) set.add(y);
    }
    set.add(thisYear());
    return [...set].sort((a,b)=>Number(b)-Number(a));
  }

  // ===== Chart (simple canvas line) =====
  function drawChart(points){
    const cvs = $("chart");
    const ctx = cvs.getContext("2d");
    const W = cvs.width, H = cvs.height;
    ctx.clearRect(0,0,W,H);

    const left=50, right=20, top=18, bottom=38;
    const w=W-left-right, h=H-top-bottom;

    // background
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,W,H);

    // grid + y labels (0-100)
    ctx.strokeStyle = "rgba(0,0,0,.08)";
    ctx.lineWidth = 1;
    ctx.font = "12px system-ui";
    ctx.fillStyle = "rgba(0,0,0,.55)";

    const yTicks = [0,25,50,75,100];
    for(const t of yTicks){
      const y = top + (1 - t/100)*h;
      ctx.beginPath();
      ctx.moveTo(left, y);
      ctx.lineTo(left+w, y);
      ctx.stroke();
      ctx.fillText(String(t), 12, y+4);
    }

    // x labels
    const step = w / (points.length-1);
    ctx.fillStyle = "rgba(0,0,0,.55)";
    points.forEach((p,i)=>{
      const x = left + i*step;
      ctx.fillText(p.label, x-12, top+h+28);
    });

    const any = points.some(p => typeof p.value==="number");
    if(!any){
      ctx.fillText("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", left, top+18);
      return;
    }

    // lineï¼ˆè‰²æŒ‡å®šã—ãªã„ç¸›ã‚ŠãŒãªã„ã®ã§å›ºå®šã§OKï¼‰
    ctx.strokeStyle = "rgba(37,99,235,.85)";
    ctx.lineWidth = 2;

    let started=false;
    ctx.beginPath();
    points.forEach((p,i)=>{
      if(typeof p.value !== "number") return;
      const x = left + i*step;
      const y = top + (1 - p.value/100)*h;
      if(!started){ ctx.moveTo(x,y); started=true; }
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // dots
    ctx.fillStyle = "rgba(37,99,235,.9)";
    points.forEach((p,i)=>{
      if(typeof p.value !== "number") return;
      const x = left + i*step;
      const y = top + (1 - p.value/100)*h;
      ctx.beginPath();
      ctx.arc(x,y,3.5,0,Math.PI*2);
      ctx.fill();
    });
  }

  function last7Dates(){
    const out=[];
    const base = new Date();
    base.setHours(0,0,0,0);
    for(let i=6;i>=0;i--){
      const d = new Date(base);
      d.setDate(base.getDate()-i);
      out.push(`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`);
    }
    return out;
  }

  // ===== State =====
  const state = {
    all: [],
    page: 1,
    q: "",
    resultFilter: "ALL",
    typeFilter: "ALL",
    statsType: "ALL",
    statsYear: thisYear(),
  };

  // ===== Filters =====
  function matchesQuery(u, q){
    if(!q) return true;
    const hay = [
      u.my1,u.my2,u.their1,u.their2,
      u.my_ban,u.their_ban,
      u.tag,u.pivot,u.next,
      u.match_type,u.turn,u.result,
      u.date,u.created_at
    ].map(x=>norm(x)).join(" / ");
    return hay.includes(q);
  }

  function passesResultFilter(u, f){
    // result ã¯ WIN/LOSE ã—ã‹ç„¡ã„å‰æï¼š
    // - ALLï¼ˆå…¨éƒ¨ï¼‰
    if(f==="ALL") return true;
    if(f==="TODAY") return String(u.date||"") === todayKey();
    return String(u.result||"") === f;
  }

  function passesTypeFilter(u, f){
    if(f==="ALL") return true;
    return String(u.match_type||"") === f;
  }

  function getFiltered(){
    const q = norm(state.q);
    return state.all.filter(u =>
      matchesQuery(u, q) &&
      passesResultFilter(u, state.resultFilter) &&
      passesTypeFilter(u, state.typeFilter)
    );
  }

  // ===== Stats =====
  function renderTodayChip(){
    const s = summarize(state.all.filter(x => String(x.date||"")===todayKey()));
    $("todayChip").textContent = `ä»Šæ—¥ï¼š${s.w}å‹${s.l}æ•—`;
  }

  function renderYearSelect(){
    const years = yearOptions(state.all);
    const sel = $("statsYear");
    sel.innerHTML = years.map(y=>`<option value="${y}">${y}å¹´</option>`).join("");
    if(!years.includes(state.statsYear)) state.statsYear = years[0] || thisYear();
    sel.value = state.statsYear;
  }

  function renderStats(){
    const base = filterByType(state.all, state.statsType);

    const today = base.filter(x => String(x.date||"")===todayKey());
    const year = base.filter(x => String(x.date||"").startsWith(state.statsYear+"-"));

    const sToday = summarize(today);
    const sYear = summarize(year);

    $("rateToday").textContent = (sToday.rate==null) ? "â€”" : `${sToday.rate}%`;
    $("rateYear").textContent  = (sYear.rate==null)  ? "â€”" : `${sYear.rate}%`;

    $("rateTodayMeta").textContent = (sToday.total===0) ? "" : `${sToday.w}å‹ / ${sToday.total}æˆ¦`;
    $("rateYearMeta").textContent  = (sYear.total===0)  ? "" : `${sYear.w}å‹ / ${sYear.total}æˆ¦ï¼ˆ${state.statsYear}å¹´ï¼‰`;
  }

  function renderChart(){
    const base = filterByType(state.all, state.statsType);
    const days = last7Dates();

    const points = days.map(d=>{
      const rows = base.filter(x => String(x.date||"")===d);
      const s = summarize(rows);
      return {
        label: d.slice(5).replace("-","/"),
        value: (s.rate==null) ? null : s.rate
      };
    });

    drawChart(points);
  }

  // ===== Paging + List =====
  function setPage(p){
    state.page = p;
    renderList();
    // ãƒšãƒ¼ã‚¸ç§»å‹•æ™‚ã¯ä¸€è¦§ä¸Šã¸ï¼ˆãƒšãƒ¼ã‚¸å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
    const top = $("listTop");
    if(top) top.scrollIntoView({ behavior:"smooth", block:"start" });
  }

  function renderPager(totalItems){
    const totalPages = Math.max(1, Math.ceil(totalItems / PER_PAGE));
    state.page = Math.min(state.page, totalPages);

    $("prevBtn").disabled = state.page<=1;
    $("nextBtn").disabled = state.page>=totalPages;

    const nums = $("pageNums");
    nums.innerHTML = "";

    const windowSize = 7;
    let start = Math.max(1, state.page - Math.floor(windowSize/2));
    let end = Math.min(totalPages, start + windowSize - 1);
    start = Math.max(1, end - windowSize + 1);

    for(let p=start;p<=end;p++){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "ghost btnSm" + (p===state.page ? " active" : "");
      b.textContent = String(p);
      b.addEventListener("click", ()=> setPage(p));
      nums.appendChild(b);
    }

    $("prevBtn").onclick = ()=> setPage(Math.max(1, state.page-1));
    $("nextBtn").onclick = ()=> setPage(Math.min(totalPages, state.page+1));
  }

  function renderList(){
    const filtered = getFiltered();
    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
    state.page = Math.min(state.page, totalPages);

    const start = (state.page-1)*PER_PAGE;
    const end = Math.min(total, start+PER_PAGE);
    $("rangeText").textContent = `${total===0?0:start+1}-${end} / ${total}ä»¶`;

    renderPager(total);

    const rows = $("rows");
    if(total===0){
      rows.innerHTML = `<div class="empty">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    const pageItems = filtered.slice(start, end);

    rows.innerHTML = pageItems.map(u=>{
      const {date, time} = parseCreatedAt(u);
      const res = (u.result==="WIN") ? "å‹ã¡" : "è² ã‘";
      const dot = (u.result==="WIN") ? "win" : "lose";
      const my = pairName(u.my1,u.my2);
      const th = pairName(u.their1,u.their2);
      const mt = typeText(u.match_type);

      const ban = `BANï¼šè‡ªåˆ† ${u.my_ban||"â€”"} / ç›¸æ‰‹ ${u.their_ban||"â€”"}`;
      const pivot = u.pivot ? `åçœï¼š${u.pivot}` : "åçœï¼š";
      const tag = u.tag ? `#${u.tag}` : "";

      return `
        <div class="row">
          <div class="rowLeft">
            <div class="time">${esc(time || "")}</div>
            <div class="badge"><span class="dot ${dot}"></span>${esc(res)}</div>
          </div>

          <div class="rowMain">
            <div class="matchLine">
              <span class="matchTitle" data-open="${esc(u.id)}">${esc(my)} vs ${esc(th)}</span>
              <span class="pill">[${esc(mt)}]</span>
              ${tag ? `<span class="pill">${esc(tag)}</span>` : ""}
            </div>
            <div class="subLine">${esc(ban)}</div>
            <div class="subLine">${esc(pivot)}</div>
          </div>
        </div>
      `;
    }).join("");

    rows.querySelectorAll("[data-open]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const id = el.getAttribute("data-open");
        const u = state.all.find(x => String(x.id)===String(id));
        if(u) openDetail(u);
      });
    });
  }

  // ===== Detail modal =====
  function openDetail(u){
    const {date, time} = parseCreatedAt(u);
    const res = (u.result==="WIN") ? "å‹ã¡" : "è² ã‘";

    const chips = [];
    chips.push(`<span class="chip">ğŸ—“ ${esc(date || u.date || "")} ${esc(time || "")}</span>`);
    chips.push(`<span class="chip">${u.result==="WIN" ? "â—" : "Ã—"} ${esc(res)}</span>`);
    if(u.match_type) chips.push(`<span class="chip">ğŸ“Œ ${esc(typeText(u.match_type))}</span>`);
    if(u.turn) chips.push(`<span class="chip">${esc(turnText(u.turn))}</span>`);
    if(u.tag) chips.push(`<span class="chip">#${esc(u.tag)}</span>`);

    $("detailMeta").innerHTML = chips.join(" ");

    const myTeam = pairName(u.my1,u.my2);
    const thTeam = pairName(u.their1,u.their2);

    const baseLines = [];
    baseLines.push(`ä½¿ç”¨ï¼š${myTeam} vs ${thTeam}`);
    baseLines.push(`å‹æ•—ï¼š${res}`);
    baseLines.push(`åŒºåˆ†ï¼š${typeText(u.match_type)}`);
    baseLines.push(`å…ˆå¾Œï¼š${turnText(u.turn)}`);
    $("detailBase").textContent = baseLines.join("\n");

    $("detailBan").textContent = `è‡ªåˆ†ï¼š${u.my_ban || "â€”"} / ç›¸æ‰‹ï¼š${u.their_ban || "â€”"}`;
    $("detailPivot").textContent = u.pivot || "â€”";
    $("detailNext").textContent  = u.next || "â€”";

    $("detailModal").style.display = "flex";
    $("detailModal").setAttribute("aria-hidden","false");
  }

  function closeDetail(){
    $("detailModal").style.display = "none";
    $("detailModal").setAttribute("aria-hidden","true");
  }
  $("closeDetail").addEventListener("click", closeDetail);

  // ===== Load =====
  async function load(){
    try{
      const res = await fetch(DATA_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("fetch failed");
      const data = await res.json();
      if(!Array.isArray(data)) throw new Error("not array");

      // æœ€ä½é™ã®æ­£è¦åŒ–ï¼ˆçµ±ä¸€JSONæƒ³å®šï¼‰
      const list = data.map(u=>{
        const c = parseCreatedAt(u);
        return {
          ...u,
          id: u.id ?? (u.created_at || u.date || String(Math.random())),
          date: u.date || c.date || "",
          result: (u.result==="WIN") ? "WIN" : "LOSE",
          match_type: u.match_type || null,
          turn: u.turn || null,
          my1: u.my1 || "",
          my2: u.my2 || "",
          their1: u.their1 || "",
          their2: u.their2 || "",
          my_ban: u.my_ban || null,
          their_ban: u.their_ban || null,
          tag: u.tag || null,
          pivot: u.pivot || null,
          next: u.next || null,
        };
      });

      // æ–°ã—ã„é †ï¼šcreated_at å„ªå…ˆ â†’ fallback date
      list.sort((a,b)=>{
        const A = String(a.created_at||"");
        const B = String(b.created_at||"");
        if(A && B) return B.localeCompare(A);
        return String(b.date||"").localeCompare(String(a.date||""));
      });

      state.all = list;

      $("countChip").textContent = `${state.all.length}ä»¶`;
      $("metaChip").textContent = `èª­è¾¼å®Œäº†`;

      // stats init
      renderYearSelect();
      $("statsType").value = state.statsType;
      $("statsYear").value = state.statsYear;

      renderTodayChip();
      renderStats();
      renderChart();

      // list init
      state.page = 1;
      renderList();

    }catch(e){
      $("metaChip").textContent = `èª­è¾¼å¤±æ•—ï¼š${DATA_URL}`;
      $("rows").innerHTML = `<div class="empty">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚<br>data/tsumilog.json ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
      drawChart([{label:"",value:null},{label:"",value:null},{label:"",value:null},{label:"",value:null},{label:"",value:null},{label:"",value:null},{label:"",value:null}]);
    }
  }

  // ===== Events =====
  $("q").addEventListener("input", ()=>{
    state.q = $("q").value;
    state.page = 1;
    renderList();
  });
  $("resultFilter").addEventListener("change", ()=>{
    state.resultFilter = $("resultFilter").value;
    state.page = 1;
    renderList();
  });
  $("typeFilter").addEventListener("change", ()=>{
    state.typeFilter = $("typeFilter").value;
    state.page = 1;
    renderList();
  });

  $("statsType").addEventListener("change", ()=>{
    state.statsType = $("statsType").value;
    renderStats();
    renderChart();
  });
  $("statsYear").addEventListener("change", ()=>{
    state.statsYear = $("statsYear").value;
    renderStats();
  });

  load();
})();
</script>
</body>
</html>