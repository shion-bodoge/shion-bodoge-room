<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ€ã„ã¤ãã®å€‰åº«</title>

<style>
:root{
  --text:#2f2830;
  --sakura:#d98cab;
  --sakura-soft:#f6e6ee;
}

body{
  margin:0;
  font-family: system-ui, sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 15% 5%, rgba(255,200,220,.25), transparent 60%),
    radial-gradient(1000px 700px at 85% 10%, rgba(255,220,235,.28), transparent 60%),
    linear-gradient(180deg, #fff9fc 0%, #f7eef3 100%);
  padding:0;
}

/* ğŸŒ¸ ãƒ˜ãƒƒãƒ€ãƒ¼ */
header{
  padding:18px 24px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background: rgba(255,255,255,.6);
  backdrop-filter: blur(6px);
  border-bottom:1px solid rgba(180,120,150,.2);
}

header a{
  text-decoration:none;
  font-size:14px;
  color:var(--text);
  opacity:.7;
}

header a:hover{
  opacity:1;
}

.container{
  max-width:720px;
  margin:60px auto;
  padding:0 20px;
}

h1{
  font-size:26px;
  margin-bottom:8px;
}

.subtitle{
  margin-bottom:30px;
  opacity:.75;
}

/* ğŸŒ¸ ã‚¨ãƒ³ãƒˆãƒªãƒ¼ */
.entry{
  background: rgba(255,255,255,.92);
  border-radius:18px;
  padding:22px;
  margin-bottom:20px;
  border:2px solid rgba(180,120,150,.35);
  box-shadow: 0 10px 25px rgba(120,70,100,.08);
  transition: transform .15s ease;
}

.entry:hover{
  transform: translateY(-2px);
}

.date{
  font-size:13px;
  opacity:.6;
  margin-bottom:8px;
}

p{
  margin:0;
  line-height:1.9;
}
</style>
</head>

<body>

<header>
  <div>ğŸ“ æ€ã„ã¤ãã®å€‰åº«</div>
  <a href="memos.html">â† ç ”ç©¶ãƒ¡ãƒ¢ã¸æˆ»ã‚‹</a>
</header>

<div class="container">

<h1>ğŸ“ æ€ã„ã¤ãã®å€‰åº«</h1>
<p class="subtitle">æ€ã„ã¤ã„ãŸã“ã¨ã€ã©ã‚“ã©ã‚“æ›¸ã“ã†</p>
<div id="tagBar"></div>
<div id="entries"></div>

</div>

<script>
  const MEMO_CSV_URL = "./data/memos.csv";
  const COMMENTS_CSV_URL = "./data/comments.csv";

  const COMMENT_FORM_PREFILL_URL =
    "https://docs.google.com/forms/d/e/1FAIpQLSd_MNIxcFujR2-iMWkFUX2b-DhJMew3LjNmxcf8tLWnNbSYzw/viewform?usp=pp_url&entry.2123112775=";

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function parseCSV(text){
    const rows = [];
    let row = [], cur = "", inQ = false;
    for (let i=0; i<text.length; i++){
      const c = text[i], n = text[i+1];
      if (c === '"'){
        if (inQ && n === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if (!inQ && c === ","){
        row.push(cur); cur = "";
      } else if (!inQ && (c === "\n" || c === "\r")){
        if (c === "\r" && n === "\n") i++;
        row.push(cur); rows.push(row);
        row = []; cur = "";
      } else {
        cur += c;
      }
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  async function loadCSV(url){
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("å–å¾—ã«å¤±æ•—: " + url);
    return await res.text();
  }

  async function loadMemos(){
    const csv = await loadCSV(MEMO_CSV_URL);
    const table = parseCSV(csv).filter(r => r.some(x => String(x).trim() !== ""));
    const header = table[0].map(h => h.trim());

    const idx = (name) => header.indexOf(name);
    const iId = idx("id");
    const iDate = idx("date");
    const iBody = idx("body");
    const iTags = idx("tags");

    if (iId < 0 || iDate < 0 || iBody < 0){
      throw new Error("memos.csv ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã« id,date,body ãŒå¿…è¦ã§ã™");
    }

    const memos = table.slice(1).map(r => {
      const tagsRaw = (iTags >= 0 ? (r[iTags] ?? "") : "").toString();
      const tags = tagsRaw
        .split(",")
        .map(t => t.trim())
        .filter(Boolean);

     return {
        id: (r[iId] ?? "").trim(),
        date: (r[iDate] ?? "").trim(),
        body: (r[iBody] ?? "").trim(),
        tags,
     };
   }).filter(m => m.id && m.body);

    memos.reverse(); // æ–°ã—ã„é †
    return memos;
  }

  async function loadComments(){
    // comments.csv ãŒã¾ã ç„¡ã„/åˆå›åŒæœŸå‰ã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã«ã™ã‚‹
    try{
      const csv = await loadCSV(COMMENTS_CSV_URL);
      const table = parseCSV(csv).filter(r => r.some(x => String(x).trim() !== ""));
      if (!table.length) return [];

      const header = table[0].map(h => h.trim());
      const idx = (name) => header.indexOf(name);

      // ã‚ãªãŸã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«åˆã‚ã›ã‚‹ï¼ˆé‡è¦ï¼‰
      const iTs = idx("ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—");
      const iMemo = idx("memoId");
      const iName = idx("name");
      const iText = idx("ã‚³ãƒ¡ãƒ³ãƒˆ");
      const iApproved = idx("approved");

      if (iMemo < 0 || iText < 0){
        // memoId ã¨ ã‚³ãƒ¡ãƒ³ãƒˆ ã ã‘ã¯å¿…é ˆ
        return [];
      }

      return table.slice(1).map(r => ({
        ts: (iTs >= 0 ? (r[iTs] ?? "") : "").trim(),
        memoId: (r[iMemo] ?? "").trim(),
        name: (iName >= 0 ? (r[iName] ?? "") : "").trim(),
        text: (r[iText] ?? "").trim(),
        approved: (iApproved >= 0 ? (r[iApproved] ?? "") : "").trim(),
      })).filter(c => c.memoId && c.text && c.approved.toLowerCase() === "true");
    }catch(e){
      return [];
    }
  }

  function setQueryMemo(memoId){
    const url = new URL(location.href);
    if (memoId) url.searchParams.set("memo", memoId);
    else url.searchParams.delete("memo");
    history.pushState({}, "", url.toString());
  }

  let activeTag = null;

  function renderTagBar(allMemos){
    const el = document.getElementById("tagBar");
    if (!el) return;

    // ã‚¿ã‚°ä¸€è¦§ä½œæˆ
    const set = new Set();
    for (const m of allMemos){
      for (const t of (m.tags || [])) set.add(t);
    }
    const tags = Array.from(set).sort((a,b)=>a.localeCompare(b,"ja"));

    // ä½•ã‚‚ã‚¿ã‚°ãŒç„¡ã„ãªã‚‰éè¡¨ç¤º
    if (tags.length === 0){
      el.innerHTML = "";
      return;
    }

    const chip = (label, isActive) => `
      <button type="button" data-tag="${escapeHtml(label)}"
        style="
          border:1px solid rgba(180,120,150,.35);
          background:${isActive ? "rgba(255,255,255,.95)" : "rgba(255,255,255,.70)"};
          border-radius:999px;
          padding:7px 12px;
          font-size:13px;
          cursor:pointer;
          color:var(--text);
          opacity:${isActive ? "1" : ".9"};
        "
      >${escapeHtml(label)}</button>
    `;

    el.innerHTML = `
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 18px;">
        ${chip("ã™ã¹ã¦", activeTag === null)}
        ${tags.map(t => chip(t, activeTag === t)).join("")}
      </div>
    `;

    el.querySelectorAll("button[data-tag]").forEach(btn => {
      btn.addEventListener("click", () => {
        const t = btn.getAttribute("data-tag");
        activeTag = (t === "ã™ã¹ã¦") ? null : t;
        setQueryTag(activeTag);
        init(); // å†æç”»
      });
    });
  }

  function setQueryTag(tag){
    const url = new URL(location.href);
    if (tag) url.searchParams.set("tag", tag);
    else url.searchParams.delete("tag");
    // memoè¡¨ç¤ºä¸­ã¯ã‚¿ã‚°ã‚ˆã‚Šmemoå„ªå…ˆã«ã—ãŸã„ã®ã§ã€tagåˆ‡æ›¿æ™‚ã«memoã¯æ¶ˆã™
    url.searchParams.delete("memo");
    history.pushState({}, "", url.toString());
  }

  function renderList(memos, comments){
    const root = document.getElementById("entries");
    root.innerHTML = "";

    // memoId â†’ ã‚³ãƒ¡ãƒ³ãƒˆæ•°ï¼ˆapprovedã®ã¿ãŒå…¥ã£ã¦ã‚‹å‰æãªã‚‰ãã®ã¾ã¾æ•°ãˆã‚‹ï¼‰
    const countMap = new Map();
    for (const c of comments){
      countMap.set(c.memoId, (countMap.get(c.memoId) || 0) + 1);
    }

    for (const m of memos){
      const safeDate = escapeHtml(m.date);
      const safeBody = escapeHtml(m.body).replaceAll("\n","<br>");
      const openUrl = new URL(location.href);
      openUrl.searchParams.set("memo", m.id);

      const n = countMap.get(m.id) || 0;
      const badgeText = n === 0 ? "ã‚³ãƒ¡ãƒ³ãƒˆãªã—" : `ã‚³ãƒ¡ãƒ³ãƒˆ ${n}`;

      const entry = document.createElement("div");
      entry.className = "entry";
      entry.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
          <div class="date">${safeDate}</div>
          <span style="
            font-size:12px;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid rgba(180,120,150,.35);
            background: rgba(255,255,255,.75);
            opacity:.9;
          ">ğŸ’¬ ${badgeText}</span>
        </div>

        <p style="margin-top:8px;">${safeBody}</p>

        <div style="display:flex;justify-content:flex-end;margin-top:14px;gap:10px;flex-wrap:wrap;">
          <a href="${openUrl.toString()}"
             style="
               border:1px solid rgba(180,120,150,.45);
               background: rgba(255,255,255,.85);
               border-radius:999px;
               padding:8px 12px;
               font-size:13px;
               text-decoration:none;
               color:var(--text);
             "
          >ğŸ“Œ ã“ã®ãƒ¡ãƒ¢ã‚’é–‹ã</a>

          <a href="${COMMENT_FORM_PREFILL_URL + encodeURIComponent(m.id)}"
             target="_blank" rel="noopener"
             style="
               border:1px solid rgba(180,120,150,.25);
               background: rgba(255,255,255,.65);
               border-radius:999px;
               padding:8px 12px;
               font-size:13px;
               text-decoration:none;
               color:var(--text);
               opacity:.9;
             "
          >ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹</a>
        </div>
      `;
      root.appendChild(entry);
    }
  }

  function renderDetail(memo, comments){
    const root = document.getElementById("entries");
    const safeDate = escapeHtml(memo.date);
    const safeBody = escapeHtml(memo.body).replaceAll("\n","<br>");
    const commentUrl = COMMENT_FORM_PREFILL_URL + encodeURIComponent(memo.id);

    const items = comments
      .filter(c => c.memoId === memo.id)
      .map(c => {
        const name = escapeHtml(c.name || "åŒ¿å");
        const ts = escapeHtml(c.ts || "");
        const text = escapeHtml(c.text).replaceAll("\n","<br>");
        const meta = ts ? `${name} ãƒ» ${ts}` : name;
        return `
          <div style="
            border:1px solid rgba(180,120,150,.25);
            background: rgba(255,255,255,.65);
            border-radius:14px;
            padding:10px 12px;
          ">
            <div style="font-size:12px;opacity:.65;margin-bottom:6px;">${meta}</div>
            <div style="font-size:14px;line-height:1.7;">${text}</div>
          </div>
        `;
      }).join("");

    root.innerHTML = `
      <div class="entry">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <div class="date">${safeDate}</div>
          <a href="#" id="backLink" style="text-decoration:none;font-size:13px;opacity:.75;color:var(--text);">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
        </div>

        <p style="margin-top:6px;">${safeBody}</p>

        <div style="margin-top:16px;padding-top:14px;border-top:1px dashed rgba(180,120,150,.35);">
          <div style="font-size:13px;opacity:.8;margin-bottom:10px;">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</div>

          <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
            <a href="${commentUrl}" target="_blank" rel="noopener"
               style="
                 border:1px solid rgba(180,120,150,.45);
                 background: rgba(255,255,255,.85);
                 border-radius:999px;
                 padding:8px 12px;
                 font-size:13px;
                 text-decoration:none;
                 color:var(--text);
               "
            >ğŸ’¬ ã“ã®ãƒ¡ãƒ¢ã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹</a>
          </div>

          <div style="display:grid;gap:10px;">
            ${items || `<div style="font-size:12px;opacity:.65;">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`}
          </div>
        </div>
      </div>
    `;

    document.getElementById("backLink").addEventListener("click", (e) => {
      e.preventDefault();
      setQueryMemo(null);
      // ä¸€è¦§ã«æˆ»ã™ãŸã‚ã«å†æç”»ï¼ˆpopstateã‚ˆã‚Šç¢ºå®Ÿï¼‰
      init();
    });
  }

  async function init(){
    const root = document.getElementById("entries");
    try{
      const [memos, comments] = await Promise.all([loadMemos(), loadComments()]);
      const memoId = new URL(location.href).searchParams.get("memo");
      const tag = new URL(location.href).searchParams.get("tag");
      activeTag = tag || null;

      if (memoId){
        const memo = memos.find(m => m.id === memoId);
        if (!memo){
          root.innerHTML = `<div class="entry"><p>æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒ¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p></div>`;
          return;
        }
        renderDetail(memo, comments);
        return;
      }

      // ä¸€è¦§è¡¨ç¤º
      renderTagBar(memos);

      const filtered = activeTag
        ? memos.filter(m => (m.tags || []).includes(activeTag))
        : memos;

      renderList(filtered, comments);

    }catch(e){
      console.error(e);
      root.innerHTML = `<div class="entry"><p>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:${escapeHtml(e.message)}</p></div>`;
    }
  }

  window.addEventListener("popstate", init);
  init();
</script>
</body>
</html>